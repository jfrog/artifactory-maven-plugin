name: Credential Validation

on:
  workflow_dispatch:  # Triggered by Jenkins or manually

jobs:
  validate-credentials:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}

      - name: Validate JFrog Artifactory Credentials
        id: validate_jfrog
        run: |
          echo "Testing JFrog Artifactory connection..."
          if jf rt ping; then
            echo "status=✅ SUCCESS" >> $GITHUB_OUTPUT
            echo "message=JFrog connection successful" >> $GITHUB_OUTPUT
            echo "✅ JFrog Artifactory credentials are valid"
          else
            echo "status=❌ FAILURE" >> $GITHUB_OUTPUT
            echo "message=JFrog connection failed" >> $GITHUB_OUTPUT
            echo "❌ JFrog Artifactory credentials validation failed"
            exit 1
          fi

      - name: Validate Maven Central (OSSRH) Credentials
        id: validate_maven_central
        if: always()  # Run even if JFrog validation fails
        run: |
          echo "Testing Maven Central (OSSRH) connection..."
          
          # Test authentication against Nexus staging profiles API
          HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' \
            -u "${{ secrets.OSSRH_USERNAME }}:${{ secrets.OSSRH_PASSWORD }}" \
            "https://oss.sonatype.org/service/local/staging/profiles")
          
          echo "Maven Central API response: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=SUCCESS" >> $GITHUB_OUTPUT
            echo "message=Maven Central connection successful" >> $GITHUB_OUTPUT
            echo "SUCCESS: Maven Central credentials are valid"
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "status=FAILURE" >> $GITHUB_OUTPUT
            echo "message=Authentication failed - invalid credentials" >> $GITHUB_OUTPUT
            echo "ERROR: Maven Central authentication failed (401)"
            exit 1
          elif [ "$HTTP_CODE" = "403" ]; then
            echo "status=SUCCESS" >> $GITHUB_OUTPUT
            echo "message=Credentials valid (limited permissions on staging API is normal)" >> $GITHUB_OUTPUT
            echo "SUCCESS: Maven Central credentials valid (403 on staging API is acceptable for deployment)"
          else
            echo "status=FAILURE" >> $GITHUB_OUTPUT
            echo "message=Connection failed - HTTP $HTTP_CODE" >> $GITHUB_OUTPUT
            echo "ERROR: Maven Central connection failed with HTTP $HTTP_CODE"
            exit 1
          fi
